import pandas as pd
import numpy as np
from dataclasses import dataclass
from datetime import datetime


@dataclass
class Trade:
    """
    Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ ÑĞ´ĞµĞ»ĞºĞµ.
    
    ĞÑ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ñ‹:
    ---------
    entry_time : datetime
        Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ² Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
    exit_time : datetime
        Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° Ğ¸Ğ· Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
    direction : str
        ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ´ĞµĞ»ĞºĞ¸: 'long' Ğ¸Ğ»Ğ¸ 'short'
    entry_price : float
        Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°
    exit_price : float
        Ğ¦ĞµĞ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°
    stop_loss : float
        Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑÑ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑĞ°
    take_profit : float
        Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ñ‚ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚Ğ°
    profit_loss : float
        Ğ§Ğ¸ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ/ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº Ğ² Ğ°Ğ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ñ‹Ñ… ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ğ°Ñ… (Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸)
    profit_loss_pct : float
        ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ/ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°Ñ…
    exit_reason : str
        ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°: 'TP', 'SL', 'Signal', 'End'
    commission_paid : float
        ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ, ÑƒĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ğ°Ñ Ğ·Ğ° ÑÑ‚Ñƒ ÑĞ´ĞµĞ»ĞºÑƒ
    """
    entry_time: datetime
    exit_time: datetime
    direction: str
    entry_price: float
    exit_price: float
    stop_loss: float
    take_profit: float
    profit_loss: float
    profit_loss_pct: float
    exit_reason: str
    commission_paid: float


class BacktestEngine:
    """
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Ğ§Ğ˜Ğ¡Ğ¢Ğ«Ğ™ Ğ”Ğ’Ğ˜Ğ–ĞĞš Ğ”Ğ›Ğ¯ Ğ‘Ğ­ĞšĞ¢Ğ•Ğ¡Ğ¢Ğ˜ĞĞ“Ğ
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    Ğ­Ñ‚Ğ¾Ñ‚ ĞºĞ»Ğ°ÑÑ â€” Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¹.
    
    Ğ¤Ğ˜Ğ›ĞĞ¡ĞĞ¤Ğ˜Ğ¯ Ğ”Ğ˜Ğ—ĞĞ™ĞĞ:
    ------------------
    â€¢ ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸ÑĞ¼Ğ¸
    â€¢ Ğ¢Ñ‹ Ğ½Ğ°ÑĞ»ĞµĞ´ÑƒĞµÑˆÑŒÑÑ Ğ¾Ñ‚ ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ°ÑÑĞ° Ğ¸ Ğ¿Ğ¸ÑˆĞµÑˆÑŒ ÑĞ²Ğ¾Ğ¹ generate_signal()
    â€¢ Ğ”Ğ²Ğ¸Ğ¶Ğ¾Ğº ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ²ÑÑ‘: ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ», ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸, ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ, Ğ¿Ñ€Ğ¾ÑĞ°Ğ´ĞºĞ¸
    
    ĞœĞĞ¢Ğ•ĞœĞĞ¢Ğ˜ĞšĞ:
    -----------
    1. ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ:
       C_total = entry_price Ã— commission_rate Ã— 2
       (Ğ´Ğ²Ğ°Ğ¶Ğ´Ñ‹: Ğ½Ğ° Ğ²Ñ…Ğ¾Ğ´ Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´)
    
    2. ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ Ğ´Ğ»Ñ LONG:
       P_gross = exit_price - entry_price
       P_net = P_gross - C_total
    
    3. ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ Ğ´Ğ»Ñ SHORT:
       P_gross = entry_price - exit_price
       P_net = P_gross - C_total
    
    4. ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°Ñ…:
       P_pct = (P_net / entry_price) Ã— 100
    
    5. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°:
       capital_new = capital_old Ã— (1 + P_pct / 100)
    
    ĞšĞĞš Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ¬:
    -----------------
    class MyStrategy(BacktestEngine):
        def generate_signal(self, index):
            # Ğ¢Ğ²Ğ¾Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ·Ğ´ĞµÑÑŒ
            if ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ_Ğ½Ğ°_Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ:
                return 'long', stop_loss, take_profit
            elif ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ_Ğ½Ğ°_Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ñƒ:
                return 'short', stop_loss, take_profit
            return None, None, None
    
    strategy = MyStrategy(data, initial_capital=10000, commission_rate=0.0008)
    strategy.run_backtest()
    strategy.print_statistics()
    strategy.save_results()
    """
    
    def __init__(self, data: pd.DataFrame, initial_capital: float = 10000.0, 
                 commission_rate: float = 0.0008):
        """
        Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ²Ğ¸Ğ¶ĞºĞ° Ğ±ÑĞºÑ‚ĞµÑÑ‚Ğ¸Ğ½Ğ³Ğ°.
        
        ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
        ----------
        data : pd.DataFrame
            DataFrame Ñ OHLCV Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸. ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸:
            - datetime : Ğ²Ñ€ĞµĞ¼Ñ
            - open     : Ñ†ĞµĞ½Ğ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
            - high     : Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼
            - low      : Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼
            - close    : Ñ†ĞµĞ½Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
            - volume   : Ğ¾Ğ±ÑŠÑ‘Ğ¼ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
        
        initial_capital : float
            ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ» (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ $10,000)
        
        commission_rate : float
            ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ Ğ±Ñ€Ğ¾ĞºĞµÑ€Ğ° Ğ² Ğ´Ğ¾Ğ»ÑÑ…:
            - 0.0008 = 0.08% = 8 Ğ±Ğ°Ğ·Ğ¸ÑĞ½Ñ‹Ñ… Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ²
            - Ğ¡Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ”Ğ’ĞĞ–Ğ”Ğ«: Ğ¿Ñ€Ğ¸ Ğ²Ñ…Ğ¾Ğ´Ğµ Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğµ
            - Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: 0.16% Ğ·Ğ° Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» ÑĞ´ĞµĞ»ĞºĞ¸
        """
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»
        self.data = data.copy()
        
        # ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»
        self.initial_capital = initial_capital
        self.current_capital = initial_capital
        
        # ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ Ğ±Ñ€Ğ¾ĞºĞµÑ€Ğ°
        self.commission_rate = commission_rate
        
        # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº
        self.trades = []
        
        # Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ°Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ (None ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸)
        self.current_position = None
        
        # ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ datetime Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
        if 'datetime' in self.data.columns:
            self.data['datetime'] = pd.to_datetime(self.data['datetime'])
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞŸĞĞ—Ğ˜Ğ¦Ğ˜Ğ¯ĞœĞ˜
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def open_position(self, index: int, direction: str, entry_price: float,
                     stop_loss: float, take_profit: float):
        """
        ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸.
        
        ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
        ----------
        index : int
            Ğ˜Ğ½Ğ´ĞµĞºÑ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² DataFrame (Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ±Ğ°Ñ€Ğ°)
        direction : str
            'long' â€” Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ° (Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ñ€Ğ¾ÑÑ‚Ğ°)
            'short' â€” Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ° (Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ)
        entry_price : float
            Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ² Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
        stop_loss : float
            Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑÑ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑĞ° (Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ÑƒĞ±Ñ‹Ñ‚ĞºĞ¾Ğ²)
        take_profit : float
            Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ñ‚ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚Ğ° (Ñ„Ğ¸ĞºÑĞ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»Ğ¸)
        
        ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ:
        -----------
        ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ ĞĞ• ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ â€” Ğ¾Ğ½Ğ° ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ
        Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¿Ğ»Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ
        Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°.
        """
        self.current_position = {
            'index': index,
            'direction': direction,
            'entry_price': entry_price,
            'stop_loss': stop_loss,
            'take_profit': take_profit,
            'entry_time': self.data.iloc[index]['datetime']
        }
    
    def close_position(self, index: int, exit_price: float, exit_reason: str):
        """
        Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°.
        
        ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
        ----------
        index : int
            Ğ˜Ğ½Ğ´ĞµĞºÑ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°
        exit_price : float
            Ğ¦ĞµĞ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° Ğ¸Ğ· Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
        exit_reason : str
            ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ:
            - 'TP' â€” Ñ‚ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»
            - 'SL' â€” ÑÑ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»
            - 'Signal' â€” Ğ·Ğ°ĞºÑ€Ñ‹Ğ»Ğ¸ Ğ¿Ğ¾ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñƒ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸
            - 'End' â€” ĞºĞ¾Ğ½ĞµÑ† Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        
        ĞœĞ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ°:
        -----------
        Ğ¨Ğ°Ğ³ 1. Ğ’Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ (Ğ±ĞµĞ· ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸):
            LONG:  P_gross = exit_price - entry_price
            SHORT: P_gross = entry_price - exit_price
        
        Ğ¨Ğ°Ğ³ 2. ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ (Ğ²Ñ…Ğ¾Ğ´ + Ğ²Ñ‹Ñ…Ğ¾Ğ´):
            C_total = entry_price Ã— commission_rate Ã— 2
        
        Ğ¨Ğ°Ğ³ 3. Ğ§Ğ¸ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ:
            P_net = P_gross - C_total
        
        Ğ¨Ğ°Ğ³ 4. ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°Ñ…:
            P_pct = (P_net / entry_price) Ã— 100
        
        Ğ¨Ğ°Ğ³ 5. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°:
            capital_new = capital_old Ã— (1 + P_pct / 100)
        """
        if self.current_position is None:
            return
        
        pos = self.current_position
        direction = pos['direction']
        entry_price = pos['entry_price']
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¨ĞĞ“ 1: Ğ ĞĞ¡Ğ§ĞĞ¢ Ğ’ĞĞ›ĞĞ’ĞĞ™ ĞŸĞ Ğ˜Ğ‘Ğ«Ğ›Ğ˜ (Ğ‘Ğ•Ğ— ĞšĞĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ˜)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if direction == 'long':
            # Ğ”Ğ»Ñ Ğ»Ğ¾Ğ½Ğ³Ğ°: Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ = Ğ½Ğ°ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ‹Ñ€Ğ¾ÑĞ»Ğ° Ñ†ĞµĞ½Ğ°
            profit_loss_gross = exit_price - entry_price
        else:  # short
            # Ğ”Ğ»Ñ ÑˆĞ¾Ñ€Ñ‚Ğ°: Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ = Ğ½Ğ°ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑƒĞ¿Ğ°Ğ»Ğ° Ñ†ĞµĞ½Ğ°
            profit_loss_gross = entry_price - exit_price
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¨ĞĞ“ 2: Ğ ĞĞ¡Ğ§ĞĞ¢ ĞšĞĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ˜ (Ğ’Ğ¥ĞĞ” + Ğ’Ğ«Ğ¥ĞĞ”)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ Ğ±ĞµÑ€Ñ‘Ñ‚ÑÑ Ğ¾Ñ‚ Ñ†ĞµĞ½Ñ‹ Ğ²Ñ…Ğ¾Ğ´Ğ°, ÑƒĞ¼Ğ½Ğ¾Ğ¶Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° 2
        # (Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ Ğ²Ñ…Ğ¾Ğ´Ğµ, Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğµ)
        commission_total = entry_price * self.commission_rate * 2
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¨ĞĞ“ 3: Ğ§Ğ˜Ğ¡Ğ¢ĞĞ¯ ĞŸĞ Ğ˜Ğ‘Ğ«Ğ›Ğ¬ (Ğ’Ğ«Ğ§Ğ˜Ğ¢ĞĞ•Ğœ ĞšĞĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ®)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        profit_loss_net = profit_loss_gross - commission_total
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¨ĞĞ“ 4: ĞŸĞ Ğ˜Ğ‘Ğ«Ğ›Ğ¬ Ğ’ ĞŸĞ ĞĞ¦Ğ•ĞĞ¢ĞĞ¥
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        profit_loss_pct = (profit_loss_net / entry_price) * 100
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¨ĞĞ“ 5: Ğ¡ĞĞ—Ğ”ĞĞĞœ ĞĞ‘ĞªĞ•ĞšĞ¢ Ğ¡Ğ”Ğ•Ğ›ĞšĞ˜
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        trade = Trade(
            entry_time=pos['entry_time'],
            exit_time=self.data.iloc[index]['datetime'],
            direction=direction,
            entry_price=entry_price,
            exit_price=exit_price,
            stop_loss=pos['stop_loss'],
            take_profit=pos['take_profit'],
            profit_loss=profit_loss_net,
            profit_loss_pct=profit_loss_pct,
            exit_reason=exit_reason,
            commission_paid=commission_total
        )
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¨ĞĞ“ 6: ĞĞ‘ĞĞĞ’Ğ›Ğ¯Ğ•Ğœ ĞšĞĞŸĞ˜Ğ¢ĞĞ›
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞšĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ» Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚/Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»Ğ¸/ÑƒĞ±Ñ‹Ñ‚ĞºĞ°
        self.current_capital *= (1 + profit_loss_pct / 100)
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¨ĞĞ“ 7: Ğ¡ĞĞ¥Ğ ĞĞĞ¯Ğ•Ğœ Ğ¡Ğ”Ğ•Ğ›ĞšĞ£ Ğ˜ Ğ¡Ğ‘Ğ ĞĞ¡Ğ«Ğ’ĞĞ•Ğœ ĞŸĞĞ—Ğ˜Ğ¦Ğ˜Ğ®
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        self.trades.append(trade)
        self.current_position = None
    
    def check_exit_conditions(self, index: int):
        """
        ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° Ğ¿Ğ¾ ÑÑ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑÑƒ Ğ¸ Ñ‚ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚Ñƒ.
        
        ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
        ----------
        index : int
            Ğ˜Ğ½Ğ´ĞµĞºÑ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ñ€)
        
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚:
        -----------
        (should_exit, exit_price, exit_reason)
        
        should_exit : bool
            True ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸
        exit_price : float Ğ¸Ğ»Ğ¸ None
            Ğ¦ĞµĞ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°
        exit_reason : str Ğ¸Ğ»Ğ¸ None
            'TP' Ğ¸Ğ»Ğ¸ 'SL'
        
        Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ LONG:
        ----------------
        â€¢ Ğ¡Ñ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑ:    low <= stop_loss  â†’ Ğ²Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ğ¾ stop_loss
        â€¢ Ğ¢ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚:  high >= take_profit â†’ Ğ²Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ğ¾ take_profit
        
        Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ SHORT:
        -----------------
        â€¢ Ğ¡Ñ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑ:    high >= stop_loss â†’ Ğ²Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ğ¾ stop_loss
        â€¢ Ğ¢ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚:  low <= take_profit â†’ Ğ²Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ğ¾ take_profit
        
        ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚:
        ----------
        Ğ¡Ñ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ ĞŸĞ•Ğ Ğ’Ğ«Ğœ. Ğ•ÑĞ»Ğ¸ Ğ¸ SL, Ğ¸ TP ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¸
        Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ±Ğ°Ñ€Ğµ â€” ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» ÑÑ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑ (Ğ¿ĞµÑÑĞ¸Ğ¼Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹
        ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¾Ñ†ĞµĞ½ĞºĞ¸ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸).
        """
        if self.current_position is None:
            return False, None, None
        
        row = self.data.iloc[index]
        pos = self.current_position
        
        if pos['direction'] == 'long':
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # LONG: Ğ–Ğ´Ñ‘Ğ¼ Ñ€Ğ¾ÑÑ‚Ğ° Ñ†ĞµĞ½Ñ‹
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            # Ğ¡Ñ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑ: Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ±Ğ°Ñ€Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ» ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹
            if row['low'] <= pos['stop_loss']:
                return True, pos['stop_loss'], 'SL'
            
            # Ğ¢ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚: Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ±Ğ°Ñ€Ğ° Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³ Ñ†ĞµĞ»Ğ¸
            if row['high'] >= pos['take_profit']:
                return True, pos['take_profit'], 'TP'
        
        else:  # short
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # SHORT: Ğ–Ğ´Ñ‘Ğ¼ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ½Ñ‹
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            # Ğ¡Ñ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑ: Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ±Ğ°Ñ€Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ» ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹
            if row['high'] >= pos['stop_loss']:
                return True, pos['stop_loss'], 'SL'
            
            # Ğ¢ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚: Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ±Ğ°Ñ€Ğ° Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³ Ñ†ĞµĞ»Ğ¸
            if row['low'] <= pos['take_profit']:
                return True, pos['take_profit'], 'TP'
        
        return False, None, None
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ Ğ¡Ğ˜Ğ“ĞĞĞ›ĞĞ’ (ĞŸĞ•Ğ Ğ•ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ¯Ğ•Ğ¢Ğ¡Ğ¯ Ğ’ Ğ”ĞĞ§Ğ•Ğ ĞĞ•Ğœ ĞšĞ›ĞĞ¡Ğ¡Ğ•)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def generate_signal(self, index: int):
        """
        Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°.
        
        âš ï¸  Ğ­Ğ¢ĞĞ¢ ĞœĞ•Ğ¢ĞĞ” Ğ”ĞĞ›Ğ–Ğ•Ğ Ğ‘Ğ«Ğ¢Ğ¬ ĞŸĞ•Ğ Ğ•ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›ĞĞ Ğ’ Ğ”ĞĞ§Ğ•Ğ ĞĞ•Ğœ ĞšĞ›ĞĞ¡Ğ¡Ğ•!
        
        ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
        ----------
        index : int
            Ğ˜Ğ½Ğ´ĞµĞºÑ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² DataFrame
        
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚:
        -----------
        (direction, stop_loss, take_profit)
        
        direction : str Ğ¸Ğ»Ğ¸ None
            'long' â€” Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°ĞµĞ¼
            'short' â€” Ğ¿Ñ€Ğ¾Ğ´Ğ°Ñ‘Ğ¼
            None â€” Ğ½ĞµÑ‚ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°
        
        stop_loss : float Ğ¸Ğ»Ğ¸ None
            Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑÑ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑĞ°
        
        take_profit : float Ğ¸Ğ»Ğ¸ None
            Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ñ‚ĞµĞ¹Ğº-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚Ğ°
        
        ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:
        ------------------
        class MyStrategy(BacktestEngine):
            def generate_signal(self, index):
                row = self.data.iloc[index]
                
                # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ½Ğ° EMA
                if row['ema_fast'] > row['ema_slow']:
                    entry = row['close']
                    sl = entry * 0.98  # 2% ÑÑ‚Ğ¾Ğ¿
                    tp = entry * 1.04  # 4% Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ‚
                    return 'long', sl, tp
                
                return None, None, None
        """
        raise NotImplementedError(
            "\n\n"
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
            "âš ï¸  ĞœĞ•Ğ¢ĞĞ” generate_signal ĞĞ• Ğ Ğ•ĞĞ›Ğ˜Ğ—ĞĞ’ĞĞ!\n"
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
            "Ğ¢Ñ‹ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¹ ĞºĞ»Ğ°ÑÑ-Ğ½Ğ°ÑĞ»ĞµĞ´Ğ½Ğ¸Ğº Ğ¸ Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ\n"
            "Ğ¼ĞµÑ‚Ğ¾Ğ´ generate_signal(), Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€:\n\n"
            "class MyStrategy(BacktestEngine):\n"
            "    def generate_signal(self, index):\n"
            "        # Ğ¢Ğ²Ğ¾Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ·Ğ´ĞµÑÑŒ\n"
            "        if ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ_Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸:\n"
            "            return 'long', stop_loss, take_profit\n"
            "        return None, None, None\n"
        )
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ‘Ğ­ĞšĞ¢Ğ•Ğ¡Ğ¢Ğ˜ĞĞ“Ğ
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def run_backtest(self, skip_bars: int = 0):
        """
        Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ±ÑĞºÑ‚ĞµÑÑ‚Ğ¸Ğ½Ğ³Ğ°.
        
        ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
        ----------
        skip_bars : int
            Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ñ… Ğ±Ğ°Ñ€Ğ¾Ğ² Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ (Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµĞ²Ğ°
            Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¾Ğ², ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ Ğ² Ğ´Ğ¾Ñ‡ĞµÑ€Ğ½ĞµĞ¼ ĞºĞ»Ğ°ÑÑĞµ)
        
        ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:
        ---------
        1. ĞŸÑ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ Ğ±Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        2. Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ°Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ â†’ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ SL/TP
        3. Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ½ĞµÑ‚ â†’ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ½Ğ° Ğ²Ñ…Ğ¾Ğ´
        4. Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½ĞµĞ·Ğ°ĞºÑ€Ñ‹Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
        
        Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: O(n), Ğ³Ğ´Ğµ n â€” ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ±Ğ°Ñ€Ğ¾Ğ²
        """
        print("â•" * 70)
        print("ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ”Ğ’Ğ˜Ğ–ĞšĞ Ğ‘Ğ­ĞšĞ¢Ğ•Ğ¡Ğ¢Ğ˜ĞĞ“Ğ")
        print("â•" * 70)
        print(f"ğŸ’° ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»:   ${self.initial_capital:,.2f}")
        print(f"ğŸ’¸ ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ Ğ±Ñ€Ğ¾ĞºĞµÑ€Ğ°:    {self.commission_rate * 100:.3f}% Ã— 2 "
              f"= {self.commission_rate * 200:.3f}% Ğ·Ğ° ÑĞ´ĞµĞ»ĞºÑƒ")
        print(f"ğŸ“Š ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ±Ğ°Ñ€Ğ¾Ğ²:    {len(self.data):,}")
        print(f"â­ï¸  ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ°Ñ€Ğ¾Ğ²:   {skip_bars}")
        print(f"ğŸ“… ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:       {self.data.iloc[0]['datetime'].date()} â†’ "
              f"{self.data.iloc[-1]['datetime'].date()}")
        print("â•" * 70)
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ“Ğ›ĞĞ’ĞĞ«Ğ™ Ğ¦Ğ˜ĞšĞ› ĞŸĞ Ğ’Ğ¡Ğ•Ğœ Ğ‘ĞĞ ĞĞœ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        for i in range(len(self.data)):
            # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ Ğ±Ğ°Ñ€Ñ‹ (Ğ´Ğ»Ñ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²)
            if i < skip_bars:
                continue
            
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ‘Ğ›ĞĞš 1: ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ£Ğ¡Ğ›ĞĞ’Ğ˜Ğ™ Ğ’Ğ«Ğ¥ĞĞ”Ğ
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if self.current_position is not None:
                should_exit, exit_price, exit_reason = self.check_exit_conditions(i)
                
                if should_exit:
                    self.close_position(i, exit_price, exit_reason)
                    continue  # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğº ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼Ñƒ Ğ±Ğ°Ñ€Ñƒ
            
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ‘Ğ›ĞĞš 2: Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ Ğ¡Ğ˜Ğ“ĞĞĞ›Ğ ĞĞ Ğ’Ğ¥ĞĞ”
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if self.current_position is None:
                direction, stop_loss, take_profit = self.generate_signal(i)
                
                if direction is not None:
                    entry_price = self.data.iloc[i]['close']
                    self.open_position(i, direction, entry_price, stop_loss, take_profit)
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ—ĞĞšĞ Ğ«Ğ’ĞĞ•Ğœ ĞĞ•Ğ—ĞĞšĞ Ğ«Ğ¢Ğ£Ğ® ĞŸĞĞ—Ğ˜Ğ¦Ğ˜Ğ® Ğ’ ĞšĞĞĞ¦Ğ• Ğ”ĞĞĞĞ«Ğ¥
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if self.current_position is not None:
            last_index = len(self.data) - 1
            exit_price = self.data.iloc[last_index]['close']
            self.close_position(last_index, exit_price, 'End')
        
        print(f"\nâœ… Ğ‘ÑĞºÑ‚ĞµÑÑ‚Ğ¸Ğ½Ğ³ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!")
        print(f"ğŸ“ˆ Ğ’ÑĞµĞ³Ğ¾ ÑĞ´ĞµĞ»Ğ¾Ğº: {len(self.trades)}")
        print("â•" * 70)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Ğ ĞĞ¡Ğ§ĞĞ¢ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜ Ğ˜ ĞœĞ•Ğ¢Ğ Ğ˜Ğš
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def calculate_statistics(self):
        """
        Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ¿Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼ Ğ±ÑĞºÑ‚ĞµÑÑ‚Ğ¸Ğ½Ğ³Ğ°.
        
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚:
        -----------
        dict Ñ ĞºĞ»ÑÑ‡Ğ°Ğ¼Ğ¸:
        
        Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸:
        ----------------
        â€¢ total_trades        : Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ´ĞµĞ»Ğ¾Ğº
        â€¢ winning_trades      : ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº
        â€¢ losing_trades       : ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑƒĞ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº
        â€¢ win_rate            : Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº
        
        Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸:
        -------------------
        â€¢ total_profit_loss     : ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ/ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº ($)
        â€¢ total_profit_loss_pct : Ğ´Ğ¾Ñ…Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ (%)
        â€¢ total_commission_paid : ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ ($)
        â€¢ final_capital         : ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ» ($)
        
        ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°:
        -----------------
        â€¢ avg_profit       : ÑÑ€ĞµĞ´Ğ½ÑÑ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ Ğ½Ğ° ÑĞ´ĞµĞ»ĞºÑƒ ($)
        â€¢ avg_loss         : ÑÑ€ĞµĞ´Ğ½Ğ¸Ğ¹ ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº Ğ½Ğ° ÑĞ´ĞµĞ»ĞºÑƒ ($)
        â€¢ profit_factor    : Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»Ğ¸ Ğº ÑƒĞ±Ñ‹Ñ‚ĞºĞ°Ğ¼
        â€¢ max_drawdown     : Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾ÑĞ°Ğ´ĞºĞ° (%)
        â€¢ sharpe_ratio     : ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ¨Ğ°Ñ€Ğ¿Ğ° (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
        
        Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ñ‹:
        --------
        Win Rate = (Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº / Ğ²ÑĞµĞ³Ğ¾ ÑĞ´ĞµĞ»Ğ¾Ğº) Ã— 100%
        
        Profit Factor = ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ½Ğ°Ñ_Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ / ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ½Ñ‹Ğ¹_ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº
        
        Max Drawdown = max((Ğ¿Ğ¸Ğº - Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ) / Ğ¿Ğ¸Ğº) Ã— 100%
        """
        if len(self.trades) == 0:
            return {
                'total_trades': 0,
                'winning_trades': 0,
                'losing_trades': 0,
                'win_rate': 0.0,
                'total_profit_loss': 0.0,
                'total_profit_loss_pct': 0.0,
                'total_commission_paid': 0.0,
                'avg_profit': 0.0,
                'avg_loss': 0.0,
                'profit_factor': 0.0,
                'max_drawdown': 0.0,
                'final_capital': self.initial_capital
            }
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ ĞĞ—Ğ”Ğ•Ğ›Ğ•ĞĞ˜Ğ• ĞĞ ĞŸĞ Ğ˜Ğ‘Ğ«Ğ›Ğ¬ĞĞ«Ğ• Ğ˜ Ğ£Ğ‘Ğ«Ğ¢ĞĞ§ĞĞ«Ğ• Ğ¡Ğ”Ğ•Ğ›ĞšĞ˜
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        winning_trades = [t for t in self.trades if t.profit_loss > 0]
        losing_trades = [t for t in self.trades if t.profit_loss <= 0]
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¡Ğ£ĞœĞœĞĞ ĞĞĞ¯ ĞŸĞ Ğ˜Ğ‘Ğ«Ğ›Ğ¬ Ğ˜ Ğ£Ğ‘Ğ«Ğ¢ĞšĞ˜
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        total_profit = sum(t.profit_loss for t in winning_trades)
        total_loss = abs(sum(t.profit_loss for t in losing_trades))
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¡Ğ£ĞœĞœĞĞ ĞĞĞ¯ ĞšĞĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯ Ğ—Ğ Ğ’Ğ¡Ğ• Ğ¡Ğ”Ğ•Ğ›ĞšĞ˜
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        total_commission = sum(t.commission_paid for t in self.trades)
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ ĞĞ¡Ğ§ĞĞ¢ ĞœĞĞšĞ¡Ğ˜ĞœĞĞ›Ğ¬ĞĞĞ™ ĞŸĞ ĞĞ¡ĞĞ”ĞšĞ˜
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¡Ñ‚Ñ€Ğ¾Ğ¸Ğ¼ ĞºÑ€Ğ¸Ğ²ÑƒÑ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°
        capital_curve = [self.initial_capital]
        for trade in self.trades:
            new_capital = capital_curve[-1] * (1 + trade.profit_loss_pct / 100)
            capital_curve.append(new_capital)
        
        # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¿Ñ€Ğ¾ÑĞ°Ğ´ĞºÑƒ
        peak = capital_curve[0]
        max_drawdown = 0.0
        
        for value in capital_curve:
            if value > peak:
                peak = value
            
            drawdown = (peak - value) / peak * 100
            if drawdown > max_drawdown:
                max_drawdown = drawdown
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¤ĞĞ ĞœĞ˜Ğ Ğ£Ğ•Ğœ Ğ¡Ğ›ĞĞ’ĞĞ Ğ¬ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ĞĞ’
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        return {
            'total_trades': len(self.trades),
            'winning_trades': len(winning_trades),
            'losing_trades': len(losing_trades),
            'win_rate': len(winning_trades) / len(self.trades) * 100,
            'total_profit_loss': sum(t.profit_loss for t in self.trades),
            'total_profit_loss_pct': (
                (self.current_capital - self.initial_capital) / 
                self.initial_capital * 100
            ),
            'total_commission_paid': total_commission,
            'avg_profit': total_profit / len(winning_trades) if winning_trades else 0.0,
            'avg_loss': total_loss / len(losing_trades) if losing_trades else 0.0,
            'profit_factor': total_profit / total_loss if total_loss > 0 else 0.0,
            'max_drawdown': max_drawdown,
            'final_capital': self.current_capital
        }
    
    def print_statistics(self):
        """
        ĞšÑ€Ğ°ÑĞ¸Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.
        """
        stats = self.calculate_statistics()
        
        print("\n" + "â•" * 70)
        print("ğŸ“Š Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« Ğ‘Ğ­ĞšĞ¢Ğ•Ğ¡Ğ¢Ğ˜ĞĞ“Ğ")
        print("â•" * 70)
        
        # ĞĞ±Ñ‰Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
        print("\nğŸ’° ĞšĞĞŸĞ˜Ğ¢ĞĞ›:")
        print(f"   ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹:  ${self.initial_capital:>15,.2f}")
        print(f"   ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹:   ${stats['final_capital']:>15,.2f}")
        print(f"   ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ:    ${stats['final_capital'] - self.initial_capital:>15,.2f} "
              f"({stats['total_profit_loss_pct']:+.2f}%)")
        print(f"   ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸:   ${stats['total_commission_paid']:>15,.2f}")
        print(f"   ĞŸÑ€Ğ¾ÑĞ°Ğ´ĞºĞ°:   {stats['max_drawdown']:>15.2f}%")
        
        # Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ´ĞµĞ»Ğ¾Ğº
        print("\nğŸ“ˆ Ğ¡Ğ”Ğ•Ğ›ĞšĞ˜:")
        print(f"   Ğ’ÑĞµĞ³Ğ¾:           {stats['total_trades']:>10}")
        print(f"   ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒĞ½Ñ‹Ñ…:      {stats['winning_trades']:>10} "
              f"({stats['win_rate']:.1f}%)")
        print(f"   Ğ£Ğ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ…:       {stats['losing_trades']:>10} "
              f"({100 - stats['win_rate']:.1f}%)")
        print(f"   Ğ¡Ñ€. Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ:     ${stats['avg_profit']:>10,.2f}")
        print(f"   Ğ¡Ñ€. ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº:      ${stats['avg_loss']:>10,.2f}")
        print(f"   Profit Factor:   {stats['profit_factor']:>10.2f}")
        
        print("â•" * 70 + "\n")
    
    def save_results(self, filename: str = 'backtest_results.txt'):
        """
        Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ² Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ».
        
        ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
        ----------
        filename : str
            Ğ˜Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
        """
        stats = self.calculate_statistics()
        
        with open(filename, 'w', encoding='utf-8') as f:
            f.write("â•" * 80 + "\n")
            f.write("ğŸ“Š Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞ«Ğ• Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« Ğ‘Ğ­ĞšĞ¢Ğ•Ğ¡Ğ¢Ğ˜ĞĞ“Ğ\n")
            f.write("â•" * 80 + "\n\n")
            
            # ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
            f
